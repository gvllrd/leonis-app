<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ã‰diteur Leonis</title>
    <style>
        /* --- DESIGN SYSTEM "PURE WHITE" --- */
        :root {
            --bg-body: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-dark: #1A202C;
            --text-grey: #718096;
            --accent: #2B6CB0; /* Bleu Leonis */
            --radius: 24px;
            --shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.08);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-dark);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding-bottom: 100px; /* Place pour le bouton save */
        }

        #app {
            width: 100%;
            max-width: 480px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 1. TITRE Ã‰DITABLE (Sans bordure noire) */
        .card-header {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            text-align: center;
            /* Border-left supprimÃ© pour un look clean */
        }
        .input-title {
            width: 100%;
            border: none;
            font-size: 22px;
            font-weight: 800;
            text-align: center;
            font-family: var(--font-main);
            color: var(--text-dark);
            background: transparent;
            outline: none;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }
        .input-title:focus { border-bottom: 2px solid var(--accent); }

        .card-header p {
            font-size: 11px;
            color: var(--text-grey);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
            font-weight: 700;
        }

        /* 2. TEXTE Ã‰DITABLE (TEXTAREA) */
        .card-text {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }
        textarea.caption-content {
            width: 100%;
            min-height: 200px;
            border: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            color: #2D3748;
            font-family: var(--font-main);
            outline: none;
            background: transparent;
            display: block;
        }
        textarea.caption-content:focus { background: #FAFAFA; }

        /* 3. HASHTAGS Ã‰DITABLES */
        .card-tags {
            background: transparent;
            padding: 0 10px;
        }
        .input-tags {
            width: 100%;
            border: none;
            background: transparent;
            color: #3182CE;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        /* 4. MEDIA */
        .media-container {
            width: 100%;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            background: #000;
            position: relative;
            min-height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .media-container img, .media-container video {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: contain;
            display: block;
        }

        /* 5. STATS */
        .card-stats {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            justify-content: space-between;
        }
        .stat-item { text-align: center; width: 48%; }
        .stat-label { font-size: 10px; color: var(--text-grey); text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px;}
        .stat-value { font-size: 14px; font-weight: 700; color: var(--text-dark); }

        /* BOUTON SAVE (Ã‰purÃ©) */
        .footer-action {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            padding: 20px;
            background: rgba(245, 247, 250, 0.95);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center;
            z-index: 100;
        }
        .btn-save {
            background-color: var(--text-dark);
            color: #FFF;
            border: none;
            padding: 16px 40px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            max-width: 440px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-save.loading { opacity: 0.7; pointer-events: none; }

        /* TOAST NOTIF */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 101;
            bottom: 100px; left: 50%; transform: translateX(-50%); font-size: 14px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* LOADER */
        .loader-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg-body); z-index: 200;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #E2E8F0;
            border-left-color: var(--text-dark); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader" class="loader-container"><div class="spinner"></div></div>

    <div id="app" style="display:none;">
        
        <div class="card-header">
            <input type="text" id="post-title" class="input-title" value="...">
            <p id="network-subtitle">Titre du Post (Modifier)</p>
        </div>

        <div class="card-text">
            <textarea id="post-text" class="caption-content"></textarea>
        </div>

        <div class="card-tags">
            <input type="text" id="post-hashtags" class="input-tags" value="">
        </div>

        <div class="media-container">
            <img id="post-image" src="" alt="Post" style="display:none;">
            <video id="post-video" controls playsinline loop style="display:none;">
                <source id="video-source" src="" type="video/mp4">
            </video>
        </div>

        <div class="card-stats">
            <div class="stat-item">
                <span class="stat-label">Objectif</span>
                <span id="stat-objective" class="stat-value">...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Projection ROI</span>
                <span id="stat-roi" class="stat-value">...</span>
            </div>
        </div>
        
        <div style="text-align:center; font-size:12px; color:#A0AEC0; margin-top:0px;">
            Modifie le texte ci-dessus et enregistre ðŸ‘‡
        </div>
    </div>

    <div class="footer-action">
        <button id="save-btn" class="btn-save" onclick="saveChanges()">Enregistrer</button>
    </div>

    <div id="toast">âœ… Modifications enregistrÃ©es !</div>

    <script>
        // ðŸ‘‡ URL SCÃ‰NARIO 3 (Lecture) ðŸ‘‡
        const READ_API = "https://hook.eu1.make.com/d2bftkhlh5qkirvb5uia3nvhuv4ebxze"; 
        
        // ðŸ‘‡ URL SCÃ‰NARIO 4 (Ã‰criture - Ã‰DITION) ðŸ‘‡
        const UPDATE_API = "https://hook.eu1.make.com/kp2xf5cs2xicyige2nytp1h7iwjf4scw"; 

        const params = new URLSearchParams(window.location.search);
        const storeId = params.get('store_id');
        const network = params.get('net');

        const networksPretty = {
            'instagram': 'Instagram', 'facebook': 'Facebook', 'twitter': 'X / Twitter',
            'linkedin': 'LinkedIn', 'tiktok': 'TikTok', 'youtube': 'YouTube',
            'pinterest': 'Pinterest', 'google': 'Google', 'threads': 'Threads', 'snapchat': 'Snapchat'
        };

        function isVideo(url) {
            if (!url) return false;
            const lowerUrl = url.toLowerCase();
            return lowerUrl.includes('.mp4') || lowerUrl.includes('.mov') || lowerUrl.includes('video');
        }

        async function loadData() {
            try {
                const response = await fetch(`${READ_API}?store_id=${storeId}`);
                const data = await response.json();
                
                const netData = data.networks && data.networks[network] ? data.networks[network] : {};

                // 1. MEDIA
                const mediaUrl = data.media_url;
                const imgElement = document.getElementById('post-image');
                const vidElement = document.getElementById('post-video');
                const vidSource = document.getElementById('video-source');

                if (isVideo(mediaUrl)) {
                    imgElement.style.display = 'none';
                    vidElement.style.display = 'block';
                    vidSource.src = mediaUrl;
                    vidElement.load();
                } else {
                    vidElement.style.display = 'none';
                    imgElement.style.display = 'block';
                    imgElement.src = mediaUrl;
                }

                // 2. REMPLIR LES CHAMPS Ã‰DITABLES
                document.getElementById('post-title').value = netData.title || networksPretty[network];
                document.getElementById('network-subtitle').innerText = "Modifier " + (networksPretty[network] || network);
                document.getElementById('post-text').value = netData.caption || "";
                document.getElementById('post-hashtags').value = netData.tags || "";

                // 3. STATS
                document.getElementById('stat-objective').innerText = netData.objective || "-";
                document.getElementById('stat-roi').innerText = netData.roi || "-";

                // AFFICHAGE
                document.getElementById('loader').style.display = 'none';
                document.getElementById('app').style.display = 'flex';

            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerHTML = "<p style='text-align:center; padding:20px;'>Erreur de chargement.<br>VÃ©rifie ton ID boutique.</p>";
            }
        }

        async function saveChanges() {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = "Enregistrement...";
            btn.classList.add('loading');

            const payload = {
                store_id: storeId,
                network: network,
                title: document.getElementById('post-title').value,
                caption: document.getElementById('post-text').value,
                tags: document.getElementById('post-hashtags').value
            };

            try {
                // Envoi vers Make ScÃ©nario 4
                await fetch(UPDATE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // SuccÃ¨s
                showToast();
                btn.innerHTML = "Enregistrer";
                btn.classList.remove('loading');

            } catch (e) {
                alert("Erreur lors de la sauvegarde. VÃ©rifie ta connexion.");
                btn.innerHTML = "RÃ©essayer";
                btn.classList.remove('loading');
            }
        }

        function showToast() {
            var x = document.getElementById("toast");
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        if(storeId && network) {
            loadData();
        } else {
            document.getElementById('loader').innerHTML = "<p style='text-align:center'>Lien incomplet.</p>";
        }
    </script>
</body>
</html>
